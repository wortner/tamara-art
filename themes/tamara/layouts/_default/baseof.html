<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang }}">
<head>
  {{ partial "head.html" . }}
</head>
<body>
  <div class="layout">
    {{ partial "sidebar.html" . }}
    <main class="content">
      {{ block "main" . }}{{ end }}
    </main>
  </div>
  <script>
    document.querySelector('.menu-toggle').addEventListener('click', function() {
      var open = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !open);
      document.querySelector('.sidebar-nav').classList.toggle('open');
    });

    (function() {
      var triggers = document.querySelectorAll('.lightbox-trigger');
      if (!triggers.length) return;

      var overlay = document.createElement('div');
      overlay.className = 'lightbox-overlay';
      overlay.innerHTML = '<button class="lightbox-close" aria-label="Close">&times;</button>' +
        '<div class="lightbox-img-wrap"><img src="" alt=""></div>';
      document.body.appendChild(overlay);

      var imgWrap = overlay.querySelector('.lightbox-img-wrap');
      var overlayImg = overlay.querySelector('img');
      var closeBtn = overlay.querySelector('.lightbox-close');
      var scale = 1;
      var translateX = 0, translateY = 0;
      var isDragging = false, startX, startY, lastTX, lastTY;

      function applyTransform() {
        overlayImg.style.transform = 'translate(' + translateX + 'px,' + translateY + 'px) scale(' + scale + ')';
        overlayImg.style.cursor = scale > 1 ? 'grab' : 'zoom-in';
      }

      function resetZoom() {
        scale = 1; translateX = 0; translateY = 0;
        applyTransform();
      }

      function zoom(delta) {
        scale = Math.min(5, Math.max(0.5, scale + delta));
        if (scale <= 1) { translateX = 0; translateY = 0; }
        applyTransform();
      }

      function open(src, alt) {
        overlayImg.src = src;
        overlayImg.alt = alt || '';
        resetZoom();
        overlay.style.display = 'flex';
        requestAnimationFrame(function() { overlay.classList.add('active'); });
        document.body.style.overflow = 'hidden';
      }

      function close() {
        overlay.classList.remove('active');
        setTimeout(function() { overlay.style.display = 'none'; overlayImg.src = ''; resetZoom(); }, 300);
        document.body.style.overflow = '';
      }

      triggers.forEach(function(trigger) {
        trigger.addEventListener('click', function(e) {
          e.preventDefault();
          open(this.href, this.querySelector('img').alt);
        });
      });

      // Scroll wheel zoom
      imgWrap.addEventListener('wheel', function(e) {
        e.preventDefault();
        zoom(e.deltaY < 0 ? 0.3 : -0.3);
      }, { passive: false });

      // Click image to zoom in, click overlay background to close
      overlayImg.addEventListener('click', function(e) {
        e.stopPropagation();
        if (!isDragging) zoom(0.5);
      });

      // Drag to pan when zoomed
      imgWrap.addEventListener('mousedown', function(e) {
        if (scale <= 1) return;
        isDragging = true;
        startX = e.clientX; startY = e.clientY;
        lastTX = translateX; lastTY = translateY;
        overlayImg.style.cursor = 'grabbing';
        e.preventDefault();
      });
      window.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        translateX = lastTX + (e.clientX - startX);
        translateY = lastTY + (e.clientY - startY);
        applyTransform();
      });
      window.addEventListener('mouseup', function() {
        if (isDragging) { isDragging = false; applyTransform(); }
      });

      // Touch: pinch to zoom + drag to pan
      var lastTouchDist = 0, lastTouchScale = 1;
      imgWrap.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
          lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
          lastTouchScale = scale;
          e.preventDefault();
        } else if (e.touches.length === 1 && scale > 1) {
          isDragging = true;
          startX = e.touches[0].clientX; startY = e.touches[0].clientY;
          lastTX = translateX; lastTY = translateY;
          e.preventDefault();
        }
      }, { passive: false });
      imgWrap.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
          var dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
          scale = Math.min(5, Math.max(0.5, lastTouchScale * (dist / lastTouchDist)));
          if (scale <= 1) { translateX = 0; translateY = 0; }
          applyTransform();
          e.preventDefault();
        } else if (isDragging && e.touches.length === 1) {
          translateX = lastTX + (e.touches[0].clientX - startX);
          translateY = lastTY + (e.touches[0].clientY - startY);
          applyTransform();
          e.preventDefault();
        }
      }, { passive: false });
      imgWrap.addEventListener('touchend', function() { isDragging = false; });

      closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', close);
      document.addEventListener('keydown', function(e) { if (e.key === 'Escape') close(); });
    })();
  </script>
</body>
</html>
